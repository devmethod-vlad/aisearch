services:
  aisearch-app:
    build:
      context: .
      dockerfile: Dockerfile_main
      args:
        - IMAGE_NAME_BASE=${IMAGE_NAME_BASE}
        - REGISTRY=${REGISTRY}
    healthcheck:
      disable: true
    command: >
      sh -c "
        exec uvicorn app.main:app --host ${APP_HOST} --port ${APP_PORT} --reload
      "
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  aisearch-celery-worker:
    build:
      context: .
      dockerfile: Dockerfile_main
      args:
        - IMAGE_NAME_BASE=${IMAGE_NAME_BASE}
        - REGISTRY=${REGISTRY}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  aisearch-redis:
    container_name: aisearch-redis
    image: redis:7.4.2
    env_file:
      - .env
    hostname: ${REDIS_HOSTNAME}
    command: --port ${REDIS_PORT}
    ports:
      - ${REDIS_PORT}:${REDIS_PORT}

  aisearch-redisinsight:
    container_name: aisearch-redisinsight
    image: redis/redisinsight:latest
    env_file:
      - .env
    ports:
      - ${REDISINSIGHT_PORT}:5540
