services:
  aisearch-app:
    container_name: aisearch-app
    build:
      context: .
      dockerfile: Dockerfile_dev
    healthcheck:
      disable: true
    command: >
      sh -c "
        poetry run uvicorn app.main:app --host ${APP_HOST} --port ${APP_PORT} --reload
      "

  aisearch-etcd:
    container_name: aisearch-etcd
    image: quay.io/coreos/etcd:v3.5.18
    env_file:
      - .env
    volumes:
      - ./volumes/etcd:/etcd
    command: etcd -advertise-client-urls=http://aisearch-etcd:${ETCD_PORT} -listen-client-urls http://0.0.0.0:${ETCD_PORT} --data-dir /etcd
    healthcheck:
      test: "curl -f ${ETCD_HOST}:${ETCD_PORT}/health || exit 1"
      interval: 30s
      timeout: 20s
      retries: 3

  aisearch-minio:
    container_name: aisearch-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    env_file:
      - .env
    ports:
      - "${MINIO_WEB_UI_PORT}:${MINIO_WEB_UI_PORT}"
      - "${MINIO_PORT}:${MINIO_PORT}"
    volumes:
      - ./volumes/minio:/minio_data
    command: minio server /minio_data --console-address ":${MINIO_WEB_UI_PORT}"
    healthcheck:
      test: "curl -f ${MINIO_HOST}:${MINIO_PORT}/minio/health/live || exit 1"
      interval: 30s
      timeout: 20s
      retries: 3

  aisearch-milvus:
    container_name: aisearch-milvus
    image: milvusdb/milvus:v2.5.12
    env_file:
      - .env
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: aisearch-etcd:${ETCD_PORT}
      MINIO_ADDRESS: aisearch-minio:${MINIO_PORT}
    volumes:
      - ./volumes/milvus:/var/lib/milvus
    healthcheck:
      test: "curl -f ${MILVUS_HOST}:${MILVUS_WEB_UI_PORT}/healthz || exit 1"
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 3
    ports:
      - "${MILVUS_PORT}:${MILVUS_PORT}"
      - "${MILVUS_WEB_UI_PORT}:${MILVUS_WEB_UI_PORT}"
    depends_on:
      - "aisearch-etcd"
      - "aisearch-minio"

  aisearch-redis:
    container_name: aisearch-redis
    image: redis:7.4.2
    env_file:
      - .env
    hostname: ${REDIS_HOSTNAME}
    command: --port ${REDIS_PORT}
    ports:
      - ${REDIS_PORT}:${REDIS_PORT}

  aisearch-redisinsight:
    container_name: aisearch-redisinsight
    image: redis/redisinsight:latest
    env_file:
      - .env
    ports:
      - ${REDISINSIGHT_PORT}:5540

  aisearch-celery-worker:
    container_name: aisearch-celery-worker
    build:
      context: .
      dockerfile: Dockerfile_dev
    depends_on:
      - aisearch-app
      - aisearch-redis
      - aisearch-milvus
